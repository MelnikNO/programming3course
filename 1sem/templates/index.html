<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç –¶–ë –†–§ - Flask</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 20px;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .currency-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .currency-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .currency-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }

        .currency-card.changed::before {
            left: 100%;
        }

        .currency-card.changed {
            background: #fff3cd;
            border-color: #ffeaa7;
        }

        .currency-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .currency-code {
            font-size: 12px;
            color: #666;
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            display: inline-block;
        }

        .currency-rate {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
        }

        .currency-change {
            font-size: 14px;
            padding: 3px 8px;
            border-radius: 4px;
            display: inline-block;
            margin-top: 5px;
        }

        .change-positive {
            background: #d4edda;
            color: #155724;
        }

        .change-negative {
            background: #f8d7da;
            color: #721c24;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: black;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        button:hover {
            opacity: 0.9;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .log {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 3px;
            border-left: 3px solid transparent;
        }

        .log-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left-color: #0c5460;
        }

        .log-update {
            background: #d4edda;
            color: #155724;
            border-left-color: #155724;
        }

        .log-error {
            background: #f8d7da;
            color: #721c24;
            border-left-color: #721c24;
        }

        .log-warning {
            background: #fff3cd;
            color: #856404;
            border-left-color: #856404;
        }

        .connection-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .connected {
            background: #28a745;
            animation: pulse 2s infinite;
        }

        .disconnected {
            background: #dc3545;
        }

        .connecting {
            background: #ffc107;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        .last-update {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .monitoring-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .monitoring-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #dc3545;
        }

        .monitoring-dot.active {
            background: #28a745;
            animation: pulse 1s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç –¶–ë –†–§</h1>
            <p>Flask + SocketIO —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞ "–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å"</p>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <strong>ID –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è:</strong>
                <span id="observerId">-</span>
            </div>
            <div class="status-item">
                <strong>–°—Ç–∞—Ç—É—Å:</strong>
                <span class="connection-status disconnected" id="connectionStatus"></span>
                <span id="connectionText">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</span>
            </div>
            <div class="status-item">
                <strong>–ù–∞–±–ª—é–¥–∞—Ç–µ–ª–µ–π –æ–Ω–ª–∞–π–Ω:</strong>
                <span id="observersCount">0</span>
            </div>
            <div class="status-item monitoring-status">
                <strong>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:</strong>
                <span class="monitoring-dot" id="monitoringDot"></span>
                <span id="monitoringStatus">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>
            </div>
            <div class="status-item">
                <strong>–ò–Ω—Ç–µ—Ä–≤–∞–ª:</strong>
                <span id="currentInterval">30</span> —Å–µ–∫
            </div>
        </div>

        <div class="controls">
            <button class="btn-success" onclick="connectSocket()" id="connectBtn">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
            <button class="btn-warning" onclick="disconnectSocket()" id="disconnectBtn" disabled>–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
            <button class="btn-primary" onclick="getCurrentRates()" id="refreshBtn" disabled>–û–±–Ω–æ–≤–∏—Ç—å –∫—É—Ä—Å—ã</button>
            <button class="btn-success" onclick="startMonitoring()" id="startMonitorBtn" disabled>–ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</button>
            <button class="btn-danger" onclick="stopMonitoring()" id="stopMonitorBtn" disabled>–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</button>
            <select id="intervalSelect" onchange="setInterval()" disabled>
                <option value="10">10 —Å–µ–∫</option>
                <option value="30" selected>30 —Å–µ–∫</option>
                <option value="60">60 —Å–µ–∫</option>
                <option value="300">5 –º–∏–Ω</option>
            </select>
        </div>

        <h3>–ö—É—Ä—Å—ã –≤–∞–ª—é—Ç –¶–ë –†–§</h3>
        <div class="currency-grid" id="currencyGrid">
            <div class="currency-card">
                <div class="currency-name">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>

        <div class="last-update" id="lastUpdate">
            –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: -
        </div>

        <h3>–ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π</h3>
        <div class="log" id="eventLog">
            <div class="log-entry log-info">–ì–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é...</div>
        </div>
    </div>

    <script>
        let socket = null;
        let observerId = null;
        let isConnected = false;
        let isMonitoring = false;

        function connectSocket() {
            if (socket && socket.connected) {
                addLog('–£–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É', 'warning');
                return;
            }

            addLog('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...', 'info');
            updateConnectionStatus('connecting');

            socket = io();

            socket.on('connect', function() {
                isConnected = true;
                updateConnectionStatus('connected');
                updateButtons();
                addLog('–£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É', 'info');
            });

            socket.on('disconnect', function() {
                isConnected = false;
                updateConnectionStatus('disconnected');
                updateButtons();
                addLog('–û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞', 'warning');
            });

            socket.on('connection_established', function(data) {
                observerId = data.observer_id;
                document.getElementById('observerId').textContent = observerId;
                document.getElementById('observersCount').textContent = data.clients_count;
                addLog(`–ü–æ–¥–∫–ª—é—á–µ–Ω –∫–∞–∫ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å: ${observerId}`, 'info');
            });

            socket.on('currency_data', function(data) {
                handleCurrencyData(data);
            });

            socket.on('currency_update', function(data) {
                addLog(`–ü–æ–ª—É—á–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–æ–≤ (broadcast)`, 'update');
                handleCurrencyData({
                    type: 'broadcast_update',
                    data: data.data,
                    timestamp: data.timestamp
                });
            });

            socket.on('interval_updated', function(data) {
                document.getElementById('currentInterval').textContent = data.interval;
                addLog(`–ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ ${data.interval} —Å–µ–∫`, 'info');
            });

            socket.on('monitoring_started', function(data) {
                isMonitoring = true;
                updateMonitoringStatus();
                addLog('–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫—É—Ä—Å–æ–≤ –∑–∞–ø—É—â–µ–Ω', 'info');
            });

            socket.on('monitoring_stopped', function(data) {
                isMonitoring = false;
                updateMonitoringStatus();
                addLog('–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫—É—Ä—Å–æ–≤ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'warning');
            });

            socket.on('clients_update', function(data) {
                document.getElementById('observersCount').textContent = data.clients_count;
                addLog(`–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤: ${data.clients_count}`, 'info');
            });

            socket.on('connect_error', function(error) {
                addLog(`–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error}`, 'error');
                updateConnectionStatus('disconnected');
                updateButtons();
            });
        }

        function disconnectSocket() {
            if (socket) {
                socket.disconnect();
                socket = null;
                observerId = null;
                isConnected = false;
                document.getElementById('observerId').textContent = '-';
                updateConnectionStatus('disconnected');
                updateButtons();
            }
        }

        function getCurrentRates() {
            if (socket && isConnected) {
                socket.emit('get_rates');
                addLog('–ó–∞–ø—Ä–æ—Å —Ç–µ–∫—É—â–∏—Ö –∫—É—Ä—Å–æ–≤...', 'info');
            } else {
                addLog('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
            }
        }

        function setInterval() {
            const interval = document.getElementById('intervalSelect').value;
            if (socket && isConnected) {
                socket.emit('set_interval', { interval: parseInt(interval) });
            }
        }

        function startMonitoring() {
            if (socket && isConnected) {
                socket.emit('start_monitoring');
            }
        }

        function stopMonitoring() {
            if (socket && isConnected) {
                socket.emit('stop_monitoring');
            }
        }

        function handleCurrencyData(data) {
            const currencyData = data.data || data;
            const type = data.type;

            if (type === 'initial_data' || type === 'current_rates') {
                addLog(`–ü–æ–ª—É—á–µ–Ω—ã ${type === 'initial_data' ? '–Ω–∞—á–∞–ª—å–Ω—ã–µ' : '—Ç–µ–∫—É—â–∏–µ'} –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç`, 'info');
            }

            updateCurrencyRates(currencyData);
            updateLastUpdate(currencyData.timestamp);

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–µ–π
            if (currencyData.observers_count !== undefined) {
                document.getElementById('observersCount').textContent = currencyData.observers_count;
            }
        }

        function updateCurrencyRates(currencyData) {
            const rates = currencyData.rates;
            const changes = currencyData.changes;
            const grid = document.getElementById('currencyGrid');

            if (!rates) {
                grid.innerHTML = '<div class="currency-card"><div class="currency-name">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div></div>';
                return;
            }

            let html = '';

            for (const [currency, rate] of Object.entries(rates)) {
                const changeInfo = changes && changes[currency];
                const hasChange = !!changeInfo;

                let changeHtml = '';
                if (hasChange) {
                    const change = changeInfo.change;
                    const changeClass = change >= 0 ? 'change-positive' : 'change-negative';
                    const changeSymbol = change >= 0 ? '‚Üë' : '‚Üì';
                    changeHtml = `
                        <div class="currency-change ${changeClass}">
                            ${changeSymbol} ${Math.abs(change).toFixed(4)}
                            (${changeInfo.change_percent.toFixed(2)}%)
                        </div>
                    `;
                }

                html += `
                    <div class="currency-card ${hasChange ? 'changed' : ''}" id="card-${currency}">
                        <div class="currency-name">${getCurrencyName(currency)}</div>
                        <div class="currency-code">${currency}</div>
                        <div class="currency-rate">${rate.toFixed(4)} ‚ÇΩ</div>
                        ${changeHtml}
                    </div>
                `;
            }

            grid.innerHTML = html;

            // –£–±–∏—Ä–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                for (const currency of Object.keys(rates)) {
                    const card = document.getElementById(`card-${currency}`);
                    if (card) {
                        card.classList.remove('changed');
                    }
                }
            }, 3000);
        }

        function getCurrencyName(code) {
            const names = {
                'USD': '–î–æ–ª–ª–∞—Ä –°–®–ê',
                'EUR': '–ï–≤—Ä–æ',
                'GBP': '–§—É–Ω—Ç —Å—Ç–µ—Ä–ª–∏–Ω–≥–æ–≤',
                'JPY': '–Ø–ø–æ–Ω—Å–∫–∞—è –∏–µ–Ω–∞',
                'CNY': '–ö–∏—Ç–∞–π—Å–∫–∏–π —é–∞–Ω—å',
                'CHF': '–®–≤–µ–π—Ü–∞—Ä—Å–∫–∏–π —Ñ—Ä–∞–Ω–∫',
                'CAD': '–ö–∞–Ω–∞–¥—Å–∫–∏–π –¥–æ–ª–ª–∞—Ä'
            };
            return names[code] || code;
        }

        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            const textElement = document.getElementById('connectionText');

            statusElement.className = 'connection-status ' + status;

            switch(status) {
                case 'connected':
                    textElement.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                    break;
                case 'connecting':
                    textElement.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
                    break;
                case 'disconnected':
                    textElement.textContent = '–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ';
                    break;
            }
        }

        function updateMonitoringStatus() {
            const dot = document.getElementById('monitoringDot');
            const status = document.getElementById('monitoringStatus');

            if (isMonitoring) {
                dot.className = 'monitoring-dot active';
                status.textContent = '–ê–∫—Ç–∏–≤–µ–Ω';
            } else {
                dot.className = 'monitoring-dot';
                status.textContent = '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω';
            }
        }

        function updateButtons() {
            document.getElementById('connectBtn').disabled = isConnected;
            document.getElementById('disconnectBtn').disabled = !isConnected;
            document.getElementById('refreshBtn').disabled = !isConnected;
            document.getElementById('startMonitorBtn').disabled = !isConnected;
            document.getElementById('stopMonitorBtn').disabled = !isConnected;
            document.getElementById('intervalSelect').disabled = !isConnected;
        }

        function updateLastUpdate(timestamp) {
            const date = new Date(timestamp);
            const formatted = date.toLocaleTimeString();
            document.getElementById('lastUpdate').textContent = `–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${formatted}`;
        }

        function addLog(message, type = 'info') {
            const log = document.getElementById('eventLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;

            log.appendChild(logEntry);
            log.scrollTop = log.scrollHeight;
        }

        // –ê–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            updateButtons();
            updateMonitoringStatus();
            connectSocket();
        };
    </script>
</body>
</html>